import React, { useEffect, useMemo, useRef, useState } from "react";

// ==============================
// EstudoHub – Hub de Materiais de Estudo (v2)
// ==============================
// Novidades desta versão:
// - Campos extras: Editora, DOI, Páginas, Ano, Periódico, Volume, Número
// - Botões "Copiar citação" em ABNT e APA (geração automática básica)
// - Integração futura com Google Drive: detecção de ID em links e botões de acesso/baixa
// - Mantida persistência em localStorage (compatível com itens antigos)

// =============== Utilidades ===============
const STORAGE_KEY_ITEMS = "estudohub_items_v1"; // mantido para compatibilidade
const STORAGE_KEY_PREFS = "estudohub_prefs_v1";

const CATEGORIES = ["Filosofia", "Jurídica", "Religião", "Saúde", "Atualidades"] as const;
const TYPES = ["Livro", "Artigo", "Notícia", "Informação", "Vídeo", "Curso", "Legislação"] as const;

function uid() {
  return Math.random().toString(36).slice(2) + Date.now().toString(36);
}

function loadLS(key, fallback) {
  try {
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : fallback;
  } catch (e) {
    return fallback;
  }
}

function saveLS(key, value) {
  try {
    localStorage.setItem(key, JSON.stringify(value));
  } catch (e) {}
}

function copy(text: string) {
  navigator.clipboard?.writeText(text).then(
    () => alert("Copiado para a área de transferência!"),
    () => {
      // fallback
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      alert("Copiado!");
    }
  );
}

// Extrai ID do Google Drive de vários formatos de URL
function parseDriveId(url: string) {
  if (!url) return "";
  const patterns = [
    /https?:\\/\\/drive\\.google\\.com\\/file\\/d\\/([^/]+)\\//,
    /https?:\\/\\/drive\\.google\\.com\\/open\\?id=([^&]+)/,
    /https?:\\/\\/drive\\.google\\.com\\/uc\\?id=([^&]+)/,
    /https?:\\/\\/docs\\.google\\.com\\/(?:document|spreadsheets|presentation)\\/d\\/([^/]+)/,
  ];
  for (const re of patterns) {
    const m = url.match(re);
    if (m) return m[1];
  }
  return "";
}

function driveViewLink(id: string) {
  return id ? `https://drive.google.com/file/d/${id}/view` : "";
}
function driveDirectDownload(id: string) {
  return id ? `https://drive.google.com/uc?export=download&id=${id}` : "";
}

// ======= Citações (simplificadas e genéricas) =======
// Regras básicas para funcionar com os campos disponíveis
function normalizeAuthors(input: string): string[] {
  if (!input) return [];
  // Espera autores separados por ";" (recomendado). Aceita também " e ", "," (com parcimônia)
  let parts = input.split(";").map((s) => s.trim()).filter(Boolean);
  if (parts.length === 1) {
    // tenta quebrar por " e " ou " and " se veio em um campo só
    parts = input.split(/\\s+e\\s+|\\s+and\\s+/i).map((s) => s.trim()).filter(Boolean);
  }
  if (parts.length === 1 && input.includes(",")) {
    parts = input.split(/,(?!\\s*Jr\\.|\\s*Filho)/).map((s) => s.trim()).filter(Boolean);
  }
  return parts.map((p) => p.replace(/\\s+/g, " "));
}

// (... resto do código permanece igual ...)
